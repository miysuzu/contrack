<!-- カスタムCSS -->
<style>
.urgent-row {
  background-color: #fff3cd !important;
  border-left: 4px solid #ffc107 !important;
}

.urgent-row:hover {
  background-color: #ffeaa7 !important;
}

.critical-row {
  background-color: #f8d7da !important;
  border-left: 4px solid #dc3545 !important;
}

.critical-row:hover {
  background-color: #f5c6cb !important;
}

.expired-row {
  background-color: #e2e3e5 !important;
  border-left: 4px solid #6c757d !important;
}

.expired-row:hover {
  background-color: #d6d8db !important;
}

.date-warning {
  color: #dc3545;
  font-weight: bold;
}

.date-soon {
  color: #fd7e14;
  font-weight: bold;
}

.date-normal {
  color: #6c757d;
}
</style>

<% if params[:keyword].present? || params[:tag].present? || params[:status_id].present? || params[:group_id].present? %>
  <section class="hero-section position-relative" style="background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.2)), url(<%= asset_path 'background_contract_list.png' %>) center/cover no-repeat; min-height: 400px; display: flex; align-items: center; border-radius: 0 0 32px 32px;">
    <div class="container text-center text-white">
      <h2 class="display-3 fw-bold" style="text-shadow: 0 2px 8px #0008;">検索結果</h2>
      <% if params[:keyword].present? %>
        <p class="fs-5" style="text-shadow: 0 1px 4px #0006;">「<%= params[:keyword] %>」の検索結果</p>
      <% else %>
        <p class="fs-5" style="text-shadow: 0 1px 4px #0006;">検索条件に一致する結果を表示します</p>
      <% end %>
    </div>
  </section>
<% else %>
  <section class="hero-section position-relative" style="background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.2)), url(<%= asset_path 'background_contract_list.png' %>) center/cover no-repeat; min-height: 400px; display: flex; align-items: center; border-radius: 0 0 32px 32px;">
    <div class="container text-center text-white">
      <h2 class="display-3 fw-bold" style="text-shadow: 0 2px 8px #0008;">契約書一覧</h2>
      <p class="fs-5" style="text-shadow: 0 1px 4px #0006;">契約書の検索・管理・作成ができます</p>
    </div>
  </section>
<% end %>

<main class="container my-5" style="max-width: 1400px; min-height: calc(100vh - 900px);">
  <div class="text-end mb-4">
    <%= link_to new_contract_path, class: "btn btn-success btn-lg rounded-pill px-4 shadow" do %>
      <i class="fas fa-plus me-2"></i>新規作成
    <% end %>
  </div>

  <!-- フィルター -->
  <div class="card rounded-4 shadow-sm mb-5 border-0 search-card">
    <div class="card-body">
      <%= form_with url: contracts_path, method: :get, local: true do %>
        <div class="row g-4 align-items-end">
          <div class="col-lg-6">
            <label class="form-label fw-semibold">キーワード検索</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <%= text_field_tag :keyword, params[:keyword], class: "form-control", placeholder: "タイトルまたは内容で検索..." %>
            </div>
          </div>
          <div class="col-lg-3">
            <label class="form-label fw-semibold">並び順</label>
            <%= select_tag :sort, options_for_select([
                ["作成日順（新しい順）", "created_desc"],
                ["作成日順（古い順）", "created_asc"],
                ["更新日順（新しい順）", "updated_desc"],
                ["更新日順（古い順）", "updated_asc"],
                ["満了日順（近い順）", "expiration_asc"],
                ["満了日順（遠い順）", "expiration_desc"],
                ["タイトル順", "title_asc"]
              ], params[:sort] || "created_desc"), class: "form-select" %>
          </div>
          <div class="col-lg-3">
            <div class="d-flex gap-2">
              <%= submit_tag "検索", class: "btn btn-outline-primary w-50" %>
              <%= link_to "クリア", contracts_path, class: "btn btn-outline-secondary w-50" %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- タグ -->
      <div class="mt-4">
        <div class="mb-2 fw-semibold">タグで絞り込む：</div>
        <div class="d-flex flex-wrap gap-2">
          <% ActsAsTaggableOn::Tag.all.each do |tag| %>
            <%= link_to contracts_path(tag: tag.name, keyword: params[:keyword], sort: params[:sort]), class: "btn btn-outline-info rounded-pill px-3 py-2 fw-semibold transition-all shadow-sm" do %>
              <i class="fas fa-tag me-2"></i><%= tag.name %>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- ステータス -->
      <div class="row mt-4 align-items-center">
        <div class="col-md-3 fw-semibold">ステータスで絞り込み：</div>
        <div class="col-md-6">
          <div class="d-flex flex-wrap gap-2">
            <%= link_to contracts_path(keyword: params[:keyword], sort: params[:sort]), class: "btn #{params[:status_id].blank? ? 'btn-primary shadow-sm' : 'btn-outline-primary'} rounded-pill px-4 py-2 fw-semibold transition-all" do %>
              <i class="fas fa-list me-2"></i>すべて
            <% end %>
            <% Status.all.each do |status| %>
              <%= link_to contracts_path(status_id: status.id, keyword: params[:keyword], sort: params[:sort]), class: "btn #{params[:status_id].to_i == status.id ? 'btn-primary shadow-sm' : 'btn-outline-primary'} rounded-pill px-4 py-2 fw-semibold transition-all" do %>
                <i class="fas fa-circle me-2"></i><%= status.name %>
              <% end %>
            <% end %>
          </div>
        </div>
        <div class="col-md-3 text-end">
          <span class="badge bg-primary fs-6 rounded-pill px-3 py-2 shadow-sm">全<%= @contracts.total_count %>件</span>
        </div>
      </div>

      <!-- グループ -->
      <div class="row mt-4 align-items-center">
        <div class="col-md-3 fw-semibold">グループで絞り込み：</div>
        <div class="col-md-6">
          <div class="d-flex flex-wrap gap-2">
            <%= link_to contracts_path(keyword: params[:keyword], sort: params[:sort], status_id: params[:status_id]), class: "btn #{params[:group_id].blank? ? 'btn-success shadow-sm' : 'btn-outline-success'} rounded-pill px-4 py-2 fw-semibold transition-all" do %>
              <i class="fas fa-users me-2"></i>すべて
            <% end %>
            <% current_user.groups.order(:name).each do |group| %>
              <%= link_to contracts_path(group_id: group.id, keyword: params[:keyword], sort: params[:sort], status_id: params[:status_id]), class: "btn #{params[:group_id].to_i == group.id ? 'btn-success shadow-sm' : 'btn-outline-success'} rounded-pill px-4 py-2 fw-semibold transition-all" do %>
                <i class="fas fa-building me-2"></i><%= group.name %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- メイン表示 -->
  <div class="row">
    <div class="col-md-3">
      <div class="card shadow-sm rounded-4 border-0">
        <div class="card-body">
          <h6 class="text-primary fw-bold mb-3">[所属グループ]</h6>
          <%= link_to contracts_path(keyword: params[:keyword], sort: params[:sort], status_id: params[:status_id]), class: "btn #{params[:group_id].blank? ? 'btn-primary' : 'btn-outline-primary'} w-100 mb-2 rounded-pill" do %>
            <i class="fas fa-users me-2"></i>すべてのグループ
          <% end %>
          <% current_user.groups.order(:name).each do |group| %>
            <%= link_to contracts_path(group_id: group.id, keyword: params[:keyword], sort: params[:sort], status_id: params[:status_id]), class: "btn #{params[:group_id].to_i == group.id ? 'btn-primary' : 'btn-outline-primary'} w-100 mb-2 rounded-pill" do %>
              <i class="fas fa-users me-2"></i><%= group.name %>
            <% end %>
          <% end %>
          <%= link_to group_searches_path, class: "btn btn-outline-info w-100 rounded-pill" do %>
            <i class="fas fa-plus me-2"></i>グループを追加
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div class="card shadow-sm rounded-4 border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">
              <% if params[:group_id].present? %>
                <% selected_group = current_user.groups.find_by(id: params[:group_id]) %>
                <%= selected_group&.name || "不明なグループ" %>の契約一覧
              <% else %>
                すべての契約一覧
              <% end %>
            </h5>
            <span class="badge bg-secondary fs-6">全<%= @contracts.total_count %>件</span>
          </div>
          
          <!-- 日付警告の説明 -->
          <div class="alert alert-info mb-3" role="alert">
            <div class="d-flex align-items-center">
              <i class="fas fa-info-circle me-2"></i>
              <div>
                <strong>日付警告について：</strong>
                <span class="text-danger ms-2"><i class="fas fa-exclamation-circle"></i> 7日以内</span>
                <span class="text-warning ms-2"><i class="fas fa-clock"></i> 30日以内</span>
              </div>
            </div>
          </div>

          <% if @contracts.any? %>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>タイトル</th>
                    <th>ステータス</th>
                    <th>タグ</th>
                    <th>期間</th>
                    <th>更新日</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <% @contracts.each do |contract| %>
                    <tr class="<%= 'critical-row' if contract.expiration_urgent? || contract.renewal_urgent? %><%= 'urgent-row' if (contract.expiration_soon? || contract.renewal_soon?) && !contract.expiration_urgent? && !contract.renewal_urgent? %><%= 'expired-row' if contract.expired? %>">
                      <td>
                        <%= link_to contract.title, contract_path(contract), class: "fw-bold text-decoration-none text-primary" %>
                      </td>
                      <td>
                        <% if contract.status&.name == "下書き" %>
                          <span class="badge bg-light status-badge"><%= contract.status.name %></span>
                        <% elsif contract.status&.name == "承認待ち" %>
                          <span class="badge bg-warning status-badge"><%= contract.status.name %></span>
                        <% elsif contract.status&.name == "確認中" %>
                          <span class="badge bg-info status-badge"><%= contract.status.name %></span>
                        <% elsif contract.status&.name == "締結済" %>
                          <span class="badge bg-success status-badge"><%= contract.status.name %></span>
                        <% elsif contract.status&.name == "アーカイブ済" %>
                          <span class="badge bg-secondary status-badge"><%= contract.status.name %></span>
                        <% elsif contract.status&.name == "差し戻し" %>
                          <span class="badge bg-danger status-badge"><%= contract.status.name %></span>
                        <% elsif contract.status&.name == "保留" %>
                          <span class="badge bg-warning status-badge"><%= contract.status.name %></span>
                        <% else %>
                          <span class="badge bg-secondary status-badge"><%= contract.status&.name || "未設定" %></span>
                        <% end %>
                      </td>
                      <td>
                        <% contract.tags.each do |tag| %>
                          <%= link_to tag.name, contracts_path(tag: tag.name), class: "badge bg-info text-dark me-1 text-decoration-none" %>
                        <% end %>
                      </td>
                      <td>
                        <% if contract.conclusion_date && contract.expiration_date %>
                          <%= contract.conclusion_date.strftime("%Y/%m/%d") %> ~ 
                          <span class="<%= 'date-warning' if contract.expiration_urgent? %><%= 'date-soon' if contract.expiration_soon? && !contract.expiration_urgent? %><%= 'date-normal' if !contract.expiration_soon? %>">
                            <%= contract.expiration_date.strftime("%Y/%m/%d") %>
                            <% if contract.expiration_urgent? %>
                              <i class="fas fa-exclamation-circle ms-1" title="7日以内に満了"></i>
                            <% elsif contract.expiration_soon? %>
                              <i class="fas fa-clock ms-1" title="30日以内に満了"></i>
                            <% end %>
                          </span>
                        <% elsif contract.conclusion_date %>
                          <%= contract.conclusion_date.strftime("%Y/%m/%d") %> ~
                        <% elsif contract.expiration_date %>
                          ~ 
                          <span class="<%= 'date-warning' if contract.expiration_urgent? %><%= 'date-soon' if contract.expiration_soon? && !contract.expiration_urgent? %><%= 'date-normal' if !contract.expiration_soon? %>">
                            <%= contract.expiration_date.strftime("%Y/%m/%d") %>
                            <% if contract.expiration_urgent? %>
                              <i class="fas fa-exclamation-circle ms-1" title="7日以内に満了"></i>
                            <% elsif contract.expiration_soon? %>
                              <i class="fas fa-clock ms-1" title="30日以内に満了"></i>
                            <% end %>
                          </span>
                        <% else %>
                          -
                        <% end %>
                      </td>
                      <td>
                        <% if contract.renewal_date.present? %>
                          <span class="<%= 'date-warning' if contract.renewal_urgent? %><%= 'date-soon' if contract.renewal_soon? && !contract.renewal_urgent? %><%= 'date-normal' if !contract.renewal_soon? %>">
                            <%= contract.renewal_date.strftime("%Y/%m/%d") %>
                            <% if contract.renewal_urgent? %>
                              <i class="fas fa-exclamation-circle ms-1" title="7日以内に更新予定"></i>
                            <% elsif contract.renewal_soon? %>
                              <i class="fas fa-clock ms-1" title="30日以内に更新予定"></i>
                            <% end %>
                          </span>
                        <% else %>
                          未設定
                        <% end %>
                      </td>
                      <td class="text-end">
                        <div class="d-flex gap-2 justify-content-end">
                          <%= link_to contract_path(contract), class: "btn btn-sm btn-outline-primary d-flex flex-column align-items-center py-2" do %>
                            <i class="fas fa-eye mb-1"></i>
                            <span style="writing-mode: vertical-rl; text-orientation: mixed;">詳細</span>
                          <% end %>
                          <%= link_to edit_contract_path(contract), class: "btn btn-sm btn-outline-warning d-flex flex-column align-items-center py-2" do %>
                            <i class="fas fa-edit mb-1"></i>
                            <span style="writing-mode: vertical-rl; text-orientation: mixed;">編集</span>
                          <% end %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-5 d-flex flex-column align-items-center justify-content-center" style="min-height: 300px;">
              <%= image_tag 'empty_contracts.png', alt: '契約書なし', class: 'mb-3', style: 'width: 120px; height: auto;' %>
              <h5 class="text-muted">契約書がまだ登録されていません</h5>
              <p class="text-muted mb-0">新しい契約書を作成してください。</p>
            </div>
          <% end %>
        </div>
      </div>

      <div class="mt-5">
        <%= paginate @contracts %>
      </div>
    </div>
  </div>
</main>
