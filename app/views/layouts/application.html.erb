<!DOCTYPE html>
<html>
<head>
  <title>Contrack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <!-- FontAwesome（CDNでOK） -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Bootstrap + 独自CSS + JS -->
  
  <%= javascript_pack_tag "application", "data-turbo-track": "reload" %>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
  <%= stylesheet_pack_tag "application", media: "all", "data-turbo-track": "reload" %>

  <!-- レスポンシブ対応用CSS -->
  <style>
    /* モバイル・タブレットでのヒーローセクションの余白調整 */
    @media (max-width: 991.98px) {
      .hero-section {
        margin-top: 80px; /* ヘッダーの高さ分の余白を追加 */
      }
    }
    
    /* デスクトップでは通常の余白 */
    @media (min-width: 992px) {
      .hero-section {
        margin-top: 0;
      }
    }
  </style>
</head>

  <body style="background-color: #f0f0f0;">
    <!-- ヘッダー -->
    <div class="header-outer">
      <div class="custom-header">
        <div class="header-inner">
          <%= link_to (user_signed_in? ? contracts_path : root_path), class: "d-flex align-items-center text-decoration-none" do %>
            <%= image_tag 'logo.png', alt: 'Contrack', style: 'height: 50px; width: auto; margin-right: 12px;' %>
          <% end %>
          
          <div class="d-flex align-items-center">
            <% if user_signed_in? %>
              <!-- ログイン時の検索窓 -->
              <div class="search-container" style="max-width: 300px; margin-right: 15px;">
                <%= form_with url: contracts_path, method: :get, local: true, class: "d-flex align-items-center" do |f| %>
                  <%= f.text_field :keyword, placeholder: "契約書を検索...", class: "form-control form-control-sm me-2", style: "border-radius: 20px; border: 1px solid #e0e0e0; width: 200px;" %>
                  <button type="submit" class="btn btn-outline-primary btn-sm" style="border-radius: 20px; padding: 0.375rem 0.75rem;">
                    <i class="fas fa-search"></i>
                  </button>
                <% end %>
              </div>
              
              <!-- 通知ボタン -->
              <div class="notification-container" style="margin-right: 15px;">
                <button class="btn btn-outline-warning btn-sm position-relative" style="border-radius: 20px; padding: 0.375rem 0.75rem;" onclick="toggleNotifications()">
                  <i class="fas fa-bell"></i>
                  <% if @notification_count && @notification_count > 0 %>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">
                      <%= @notification_count > 99 ? '99+' : @notification_count %>
                    </span>
                  <% end %>
                </button>
              </div>
            <% end %>
            
            <div class="menu-button" onclick="toggleMenu()">≡</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 通知ドロップダウン -->
    <% if user_signed_in? %>
      <div id="notificationDropdown" class="notification-dropdown" style="display: none;">
        <div class="notification-header">
          <h6 class="mb-0 fw-bold">通知</h6>
          <button type="button" class="btn-close btn-close-sm" onclick="toggleNotifications()"></button>
        </div>
        <div class="notification-content">
          <% if @expiring_contracts&.any? %>
            <div class="notification-section">
              <h6 class="text-warning mb-2">
                <i class="fas fa-exclamation-triangle me-1"></i>満了予定の契約書
              </h6>
              <% @expiring_contracts.each do |contract| %>
                <div class="notification-item">
                  <div class="notification-title">
                    <%= link_to contract.title, contract_path(contract), class: "text-decoration-none" %>
                  </div>
                  <div class="notification-detail">
                    満了日: <%= contract.expiration_date.strftime('%Y/%m/%d') %>
                    (残り<%= (contract.expiration_date - Date.current).to_i %>日)
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
          
          <% if @renewal_contracts&.any? %>
            <div class="notification-section">
              <h6 class="text-info mb-2">
                <i class="fas fa-sync-alt me-1"></i>更新予定の契約書
              </h6>
              <% @renewal_contracts.each do |contract| %>
                <div class="notification-item">
                  <div class="notification-title">
                    <%= link_to contract.title, contract_path(contract), class: "text-decoration-none" %>
                  </div>
                  <div class="notification-detail">
                    更新日: <%= contract.renewal_date.strftime('%Y/%m/%d') %>
                    (残り<%= (contract.renewal_date - Date.current).to_i %>日)
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
          
          <% if @comment_notifications&.any? %>
            <div class="notification-section">
              <h6 class="text-warning mb-2">
                <i class="fas fa-comment me-1"></i>コメント通知
              </h6>
              <% @comment_notifications.each do |notification| %>
                <div class="notification-item">
                  <% if notification.comment.present? %>
                    <div class="notification-title">
                      <%= link_to notification.comment.contract.title, contract_path(notification.comment.contract), class: "text-decoration-none" %>
                    </div>
                    <div class="notification-detail">
                      <%= notification.comment.commentable.name %>さんがコメントしました
                      <small class="text-muted d-block">
                        <%= notification.created_at.strftime('%Y/%m/%d %H:%M') %>
                      </small>
                    </div>
                  <% elsif notification.notifiable_type == 'GroupJoinRequest' %>
                    <div class="notification-title">
                      <%= link_to "グループ参加申請", group_searches_path, class: "text-decoration-none" %>
                    </div>
                    <div class="notification-detail">
                      <%= notification.message %>
                      <small class="text-muted d-block">
                        <%= notification.created_at.strftime('%Y/%m/%d %H:%M') %>
                      </small>
                    </div>
                  <% end %>
                  <%= link_to "既読", mark_as_read_comment_notification_path(notification), method: :patch, class: "btn btn-sm btn-outline-secondary mt-1" %>
                </div>
              <% end %>
              <div class="mt-2">
                <%= link_to "全て既読にする", mark_all_as_read_comment_notifications_path, method: :patch, class: "btn btn-sm btn-outline-primary" %>
              </div>
            </div>
          <% end %>
          
          <% if !@expiring_contracts&.any? && !@renewal_contracts&.any? && !@comment_notifications&.any? %>
            <div class="notification-empty">
              <i class="fas fa-check-circle text-success mb-2"></i>
              <p class="mb-0">通知はありません</p>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if controller_name == 'home' && action_name == 'index' %>
      <!-- メインビジュアル -->
      <div class="main-visual">
        <%= image_tag 'main_visual.jpg', alt: 'Main Visual' %>
      </div>
    <% end %>
  
  <!-- フルスクリーンメニュー -->
  <div id="fullscreenMenu" class="fullscreen-menu">
    <div class="menu-close" onclick="closeMenu()">
      <i class="fas fa-times"></i>
    </div>
  
    <div class="menu-logo-wrapper">
      <%= link_to (user_signed_in? ? contracts_path : root_path) do %>
        <%= image_tag 'logo.png', class: 'menu-logo' %>
      <% end %>
    </div>
  
    <div class="menu-content">
      <div class="menu-inner">
        <h2 class="catch-main">契約管理を、もっとスマートに。</h2>
        <p class="catch-sub">契約書の作成・共有・更新まで、一元管理</p>
  
        <% if user_signed_in? %>
          <%= link_to contracts_path, class: "btn btn-light text-dark fw-semibold" do %>
            <i class="fas fa-file-contract me-2"></i> 契約書一覧
          <% end %>
          <%= link_to new_contract_path, class: "btn btn-outline-light fw-semibold" do %>
            <i class="fas fa-plus-circle me-2"></i> 新規作成
          <% end %>
          <%= link_to group_searches_path, class: "btn btn-outline-light fw-semibold" do %>
            <i class="fas fa-users me-2"></i> グループ検索・一覧
          <% end %>
          <%= link_to group_join_requests_path, class: "btn btn-outline-light fw-semibold position-relative" do %>
            <i class="fas fa-user-plus me-2"></i> グループ参加申請一覧
            <% if @group_join_request_count && @group_join_request_count > 0 %>
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">
                <%= @group_join_request_count > 99 ? '99+' : @group_join_request_count %>
              </span>
            <% end %>
          <% end %>
          <%= link_to tags_path, class: "btn btn-outline-light fw-semibold" do %>
            <i class="fas fa-tags me-2"></i> タグ一覧
          <% end %>
          <%= link_to slack_message_templates_path, class: "btn btn-outline-light fw-semibold" do %>
            <i class="fab fa-slack me-2"></i> Slackテンプレート管理
          <% end %>
          <%= link_to user_mypage_path, class: "btn btn-outline-light fw-semibold" do %>
            <i class="fas fa-user me-2"></i> マイページ
          <% end %>
          <%= link_to destroy_user_session_path, method: :delete, data: { confirm: "ログアウトしますか？" }, class: "btn btn-outline-danger fw-semibold" do %>
            <i class="fas fa-sign-out-alt me-2"></i> ログアウト
          <% end %>
        <% else %>
          <%= link_to new_user_registration_path, class: "btn btn-primary btn-lg fw-semibold mb-3" do %>
            <i class="fas fa-user-plus me-2"></i> 新規会員登録
          <% end %>
          <%= link_to new_user_session_path, class: "btn btn-outline-light btn-lg fw-semibold" do %>
            <i class="fas fa-sign-in-alt me-2"></i> ログイン
          <% end %>
        <% end %>
  

      </div>
  
      <p class="menu-description">Smart Contract Management by Contrack</p>
    </div>
  </div>

    <!-- フラッシュメッセージ＋エラーメッセージ -->
      <% if notice %>
      <div class="alert alert-success flash-message alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i><%= notice %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% end %>
    
    <% if alert %>
      <div class="alert alert-danger flash-message alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i><%= alert %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% end %>
    
    <% if flash[:validation_errors] && !(controller_name == 'slack_message_templates' && ['new', 'edit'].include?(action_name)) %>
      <div class="alert alert-danger flash-message alert-dismissible fade show" role="alert">
        <h5 class="fw-bold"><%= pluralize(flash[:validation_errors].count, "件のエラー") %>があります:</h5>
        <ul class="mb-0">
          <% flash[:validation_errors].each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% end %>

    <!-- メイン -->
    <main style="max-width: 3000px; margin: 0 auto; padding: 0 20px;">
      <%= yield %>
    </main>

    <!-- フッター -->
    <footer class="bg-white border-top shadow-sm <%= (controller_name == 'sessions' && action_name == 'new') || (controller_name == 'registrations' && action_name == 'new') || (controller_name == 'passwords' && ['new', 'edit'].include?(action_name)) ? 'mt-0' : 'mt-5' %>">
      <div class="container py-5">
        <div class="row text-muted small align-items-start">
    
          <!-- 左：ロゴと名称＋説明 -->
          <div class="col-md-4 mb-4 mb-md-0">
            <div class="d-flex align-items-center mb-2">
              <i class="fas fa-file-contract text-primary me-2 fa-lg"></i>
              <span class="fw-semibold text-dark">Contrack</span>
            </div>
            <p class="mb-0 lh-sm">
              契約管理を、もっとスマートに。<br>
              契約書の作成・共有・更新まで、一元管理
            </p>
          </div>
    
          <!-- 中央：リンク風の情報ブロック -->
          <div class="col-md-4 mb-4 mb-md-0 text-center">
            <div class="fw-semibold text-dark mb-2">ご利用ガイド</div>
            <ul class="list-unstyled mb-0">
              <li class="mb-1">利用規約について</li>
              <li class="mb-1">プライバシーポリシー</li>
              <li>セキュリティに関する取り組み</li>
            </ul>
          </div>
    
          <!-- 右：会社情報風 -->
          <div class="col-md-4 text-md-end text-center">
            <div class="fw-semibold mb-1">提供：Contrack開発チーム</div>
            <div class="text-muted small">
              &copy; <%= Time.current.year %> Contrack, Inc.<br class="d-md-none">
              All rights reserved.
            </div>
          </div>
    
        </div>
      </div>
    </footer>
    

    <!-- JS for menu toggle -->
    <script>
      function toggleMenu() {
        const menu = document.getElementById("fullscreenMenu");
        menu.classList.toggle("show");
      }
    
      function closeMenu() {
        const menu = document.getElementById("fullscreenMenu");
        menu.classList.remove("show");
      }
    </script>

    <!-- JS for flash message auto-dismiss -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // フラッシュメッセージとエラーメッセージの自動消去
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
          // 5秒後に自動消去
          setTimeout(function() {
            alert.classList.add('fade-out');
            setTimeout(function() {
              alert.remove();
            }, 500);
          }, 5000);
          
          // 閉じるボタンのクリックイベント
          const closeButton = alert.querySelector('.btn-close');
          if (closeButton) {
            closeButton.addEventListener('click', function() {
              alert.classList.add('fade-out');
              setTimeout(function() {
                alert.remove();
              }, 500);
            });
          }
        });

        // エラーメッセージが表示されている場合、ページ遷移時にクリア
        if (document.querySelector('.alert-danger')) {
          window.addEventListener('beforeunload', function() {
            // エラーメッセージをクリア
            const errorAlerts = document.querySelectorAll('.alert-danger');
            errorAlerts.forEach(function(alert) {
              alert.remove();
            });
          });
        }

      });
    </script>

    <!-- JS for notification dropdown -->
    <script>
      function toggleNotifications() {
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown.style.display === 'none' || dropdown.style.display === '') {
          dropdown.style.display = 'block';
        } else {
          dropdown.style.display = 'none';
        }
      }

      // 通知ドロップダウンの外側をクリックした時に閉じる
      document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('notificationDropdown');
        const bell = document.querySelector('.notification-container button');
        if (!dropdown || !bell) return;
        
        if (!dropdown.contains(event.target) && !bell.contains(event.target)) {
          dropdown.style.display = 'none';
        }
      });
    </script>

    <!-- 共通画像プレビューモーダル -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="imageModalLabel">画像プレビュー</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center p-0">
            <img id="modalImage" src="" class="img-fluid" style="max-height: 80vh; width: auto;" alt="">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            <a id="downloadLink" href="" class="btn btn-primary" download>
              <i class="fas fa-download me-1"></i>ダウンロード
            </a>
          </div>
        </div>
      </div>
    </div>
    
  </body>
</html>
