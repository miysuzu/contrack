<!-- Heroセクション -->
<section class="hero-section position-relative" style="background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.2)), url(<%= asset_path 'background_admin.png' %>) center/cover no-repeat; min-height: 400px; display: flex; align-items: center; border-radius: 0 0 32px 32px;">
  <div class="container text-center text-white">
    <h2 class="display-3 fw-bold" style="text-shadow: 0 2px 8px #0008;">
      <i class="fas fa-edit me-3"></i>契約書を編集（管理者）
    </h2>
    <p class="fs-5" style="text-shadow: 0 1px 4px #0006;">契約書の情報を編集できます</p>
  </div>
</section>

<div class="custom-wide-container fade-in" style="width: 100%; max-width: 1500px; margin: 48px auto 0 auto; padding-left: 24px; padding-right: 24px;">
  <div class="card shadow rounded-4 border-0">
    <div class="card-body p-4">
      <div class="row g-4">
        <!-- フォーム（左・約50%） -->
        <div class="col-12 col-md-6">
          <% if @contract.errors.any? %>
            <div class="alert alert-danger">
              <h4><%= @contract.errors.count %>件のエラーが発生しました</h4>
              <ul>
                <% @contract.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <%= form_with model: [:admin, @contract], local: true, multipart: true do |f| %>
            <div class="form-group mb-3">
              <%= f.label :user_id, "契約者", class: "form-label fw-bold" %>
              <%= f.collection_select :user_id, 
                  @users, 
                  :id, :name, 
                  { selected: @contract.user_id.nil? ? "admin_#{current_admin.id}" : @contract.user_id }, 
                  { class: "form-control rounded-3 shadow-sm" } %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :title, "契約タイトル", class: "form-label fw-bold" %>
              <%= f.text_field :title, class: "form-control rounded-3 shadow-sm" %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :body, "契約内容", class: "form-label fw-bold" %>
              <%= f.text_area :body, rows: 8, class: "form-control rounded-3 shadow-sm" %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :status_id, "ステータス", class: "form-label fw-bold" %>
              <%= f.collection_select :status_id, Status.all, :id, :name, {}, { class: "form-control rounded-3 shadow-sm" } %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :tag_list, "タグ（カンマ区切り）", class: "form-label fw-bold" %>
              <%= f.text_field :tag_list, value: @contract.tag_list.join(", "), class: "form-control rounded-3 shadow-sm" %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :group_id, "グループ", class: "form-label fw-bold" %>
              <%= f.collection_select :group_id, @groups, :id, :name, { include_blank: "選択してください" }, { class: "form-control rounded-3 shadow-sm" } %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :admin_only, class: "form-label fw-bold" do %>
                <%= f.check_box :admin_only, class: "form-check-input me-2" %>
                管理者のみアクセス可能にする
              <% end %>
              <small class="form-text text-muted">チェックすると、この契約書は管理者のみがアクセスできます</small>
            </div>

            <div class="form-group mb-3">
              <%= f.label :contract_conclusion_date, "契約締結日", class: "form-label fw-bold" %>
              <%= f.date_field :contract_conclusion_date, class: "form-control rounded-3 shadow-sm" %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :contract_start_date, "契約開始日", class: "form-label fw-bold" %>
              <%= f.date_field :contract_start_date, class: "form-control rounded-3 shadow-sm" %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :expiration_date, "契約満了日", class: "form-label fw-bold" %>
              <%= f.date_field :expiration_date, class: "form-control rounded-3 shadow-sm" %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :renewal_date, "契約更新日", class: "form-label fw-bold" %>
              <%= f.date_field :renewal_date, class: "form-control rounded-3 shadow-sm" %>
            </div>

            <div class="form-group mb-3">
              <%= f.label :attachments, "添付ファイル", class: "form-label fw-bold" %>
              <%= f.file_field :attachments, multiple: true, class: "form-control rounded-3 shadow-sm", id: "file-input", accept: "image/*,.pdf,.doc,.docx,.xls,.xlsx" %>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
              <%= f.submit "更新", class: "btn btn-primary px-4" %>
            </div>
          <% end %>
        </div>

        <!-- プレビュー（右・約50%） -->
        <div class="col-12 col-md-6">
          <div id="pre-upload-preview"
               style="min-height: 500px; border: 2px dashed #b0c4de; border-radius: 12px; background: #f8fafc; padding: 1.5rem; overflow: auto;">
            <div class="text-center text-muted py-4">
              <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
              <p>ここに画像やPDFのプレビューが表示されます</p>
            </div>

            <% if @contract.attachments.attached? %>
              <div>
                <strong class="text-dark">添付ファイル</strong>
                <div class="mt-3">
                  <div class="row">
                    <% @contract.attachments.each do |attachment| %>
                      <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm" style="min-width: 300px;">
                          <div class="card-body p-3">
                            <div class="d-flex align-items-center mb-2">
                              <i class="fas fa-paperclip me-2 text-muted"></i>
                              <small class="text-muted flex-grow-1"><%= attachment.filename %></small>
                              <small class="text-muted">(<%= number_to_human_size(attachment.byte_size) %>)</small>
                            </div>

                            <% if attachment.content_type.start_with?('image/') %>
                              <%= image_tag attachment, class: "img-fluid rounded", style: "max-height: 200px; width: 100%; object-fit: cover;" %>
                            <% elsif attachment.content_type == 'application/pdf' %>
                              <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-file-pdf fa-3x text-danger mb-2"></i>
                                <p class="mb-0 text-muted">PDFファイル</p>
                              </div>
                            <% else %>
                              <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-file fa-3x text-primary mb-2"></i>
                                <p class="mb-0 text-muted">ファイル</p>
                              </div>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mt-5 text-center">
  <%= link_to "一覧に戻る", admin_contracts_path, class: "btn btn-secondary px-4" %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const fileInput = document.getElementById('file-input');
  const preview = document.getElementById('pre-upload-preview');

  fileInput.addEventListener('change', function(e) {
    const files = e.target.files;
    if (files.length > 0) {
      preview.innerHTML = '';
      
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const filePreview = document.createElement('div');
          filePreview.className = 'col-md-6 col-lg-4 mb-3';
          
          if (file.type.startsWith('image/')) {
            filePreview.innerHTML = `
              <div class="card h-100 border-0 shadow-sm" style="min-width: 300px;">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-image me-2 text-primary"></i>
                    <small class="text-muted flex-grow-1">${file.name}</small>
                    <small class="text-muted">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                  </div>
                  <img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px; width: 100%; object-fit: cover;">
                </div>
              </div>
            `;
          } else if (file.type === 'application/pdf') {
            filePreview.innerHTML = `
              <div class="card h-100 border-0 shadow-sm" style="min-width: 300px;">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-file-pdf me-2 text-danger"></i>
                    <small class="text-muted flex-grow-1">${file.name}</small>
                    <small class="text-muted">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                  </div>
                  <div class="text-center p-3 bg-light rounded">
                    <i class="fas fa-file-pdf fa-3x text-danger mb-2"></i>
                    <p class="mb-0 text-muted">PDFファイル</p>
                  </div>
                </div>
              </div>
            `;
          } else {
            filePreview.innerHTML = `
              <div class="card h-100 border-0 shadow-sm" style="min-width: 300px;">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-file me-2 text-primary"></i>
                    <small class="text-muted flex-grow-1">${file.name}</small>
                    <small class="text-muted">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                  </div>
                  <div class="text-center p-3 bg-light rounded">
                    <i class="fas fa-file fa-3x text-primary mb-2"></i>
                    <p class="mb-0 text-muted">ファイル</p>
                  </div>
                </div>
              </div>
            `;
          }
          
          preview.appendChild(filePreview);
        };
        reader.readAsDataURL(file);
      });
    }
  });
});
</script>